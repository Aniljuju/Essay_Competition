{% extends "custom_admin/base.html" %}
{% block title %}Users{% endblock %}
{% block page_title %}User Management{% endblock %}
{% block active_users %}active{% endblock %}

{% block content %}

<div class="page-header">
  <div>
    <h2 class="section-title">All Users</h2>
    <p class="page-subtitle">
      {{ total_count }} user{{ total_count|pluralize }}
      {% if search_query or status_filter %}
        · <a href="{% url 'custom_admin:users' %}" class="clear-link"><i class="bi bi-x-circle"></i> Clear filters</a>
      {% endif %}
    </p>
  </div>
</div>

<!-- Filter bar -->
<form method="get" id="filterForm">
  <div class="filter-bar">
    <div class="flex-grow-1" style="min-width:200px;">
      <input type="text" name="q" class="ca-input" placeholder="Search username or email…" value="{{ search_query }}"/>
    </div>
    <div style="min-width:150px;">
      <select name="status" class="ca-select" onchange="document.getElementById('filterForm').submit()">
        <option value="">All Statuses</option>
        <option value="pending"  {% if status_filter == 'pending'  %}selected{% endif %}>Pending</option>
        <option value="verified" {% if status_filter == 'verified' %}selected{% endif %}>Verified</option>
        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
      </select>
    </div>
    <button type="submit" class="btn-navy"><i class="bi bi-search"></i> Search</button>
    {% if search_query or status_filter %}
    <a href="{% url 'custom_admin:users' %}" class="btn-outline"><i class="bi bi-x-lg"></i></a>
    {% endif %}
  </div>
</form>

<!-- Table -->
<div class="ca-table-wrap">
  <table class="ca-table">
    <thead>
      <tr>
        <th>#</th>
        <th>User</th>
        <th>Email</th>
        <th>Joined</th>
        <th>Status</th>
        <th>Change Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr id="user-row-{{ u.pk }}">
        <td class="row-num">{{ forloop.counter }}</td>
        <td>
          <div class="d-flex align-items-center gap-2">
            <div class="avatar">{{ u.username|first|upper }}</div>
            <div>
              <div class="fw-600">{{ u.username }}</div>
              {% if u.is_staff %}<div class="staff-label">STAFF</div>{% endif %}
            </div>
          </div>
        </td>
        <td class="text-muted-sm">{{ u.email|default:"—" }}</td>
        <td class="text-muted-sm">{{ u.date_joined|date:"M d, Y" }}</td>
        <td>
          <span class="badge badge-{{ u.profile.status }}" id="badge-{{ u.pk }}">
            {% if u.profile.status == 'pending' %}<i class="bi bi-hourglass-split"></i>
            {% elif u.profile.status == 'verified' %}<i class="bi bi-patch-check-fill"></i>
            {% else %}<i class="bi bi-x-circle-fill"></i>{% endif %}
            {{ u.profile.status|capfirst }}
          </span>
        </td>
        <td>
          <select class="ca-select-sm status-select"
                  data-user-id="{{ u.pk }}"
                  data-url="{% url 'custom_admin:update_user_status' %}">
            <option value="pending"  {% if u.profile.status == 'pending'  %}selected{% endif %}>Pending</option>
            <option value="verified" {% if u.profile.status == 'verified' %}selected{% endif %}>Verified</option>
            <option value="rejected" {% if u.profile.status == 'rejected' %}selected{% endif %}>Rejected</option>
          </select>
        </td>
        <td>
          <button class="btn-icon btn-danger delete-btn"
                  data-user-id="{{ u.pk }}"
                  data-username="{{ u.username }}"
                  data-url="{% url 'custom_admin:delete_user' %}"
                  title="Delete {{ u.username }}">
            <i class="bi bi-trash3-fill"></i>
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="empty-cell">
          <i class="bi bi-person-x" style="font-size:2rem;display:block;margin-bottom:8px;"></i>
          No users match your search.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
{% if users.has_other_pages %}
<div class="ca-pagination">
  <span class="ca-pagination-info">Page {{ users.number }} of {{ users.paginator.num_pages }} · {{ total_count }} users</span>
  <div class="ca-pagination-links">
    {% if users.has_previous %}
    <a class="ca-page-btn" href="?page={{ users.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
      <i class="bi bi-chevron-left"></i>
    </a>
    {% endif %}
    {% for num in users.paginator.page_range %}
      {% if users.number == num %}
        <span class="ca-page-btn active">{{ num }}</span>
      {% elif num > users.number|add:"-3" and num < users.number|add:"3" %}
        <a class="ca-page-btn" href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
      {% endif %}
    {% endfor %}
    {% if users.has_next %}
    <a class="ca-page-btn" href="?page={{ users.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
      <i class="bi bi-chevron-right"></i>
    </a>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Delete Confirm Modal -->
<div class="modal fade ca-modal" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width:420px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Delete User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p style="color:var(--ink-mid);margin:0;">
          Permanently delete <strong id="deleteModalUsername" style="color:var(--ink);"></strong>? This cannot be undone and will remove all their essays.
        </p>
      </div>
      <div class="modal-footer gap-2">
        <button type="button" class="btn-outline" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn-navy" style="background:#dc3545;">
          <i class="bi bi-trash3-fill"></i> Delete Permanently
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
"use strict";

// AJAX status update
document.querySelectorAll('.status-select').forEach(sel => {
  sel.addEventListener('change', async function() {
    const uid = this.dataset.userId;
    const url = this.dataset.url;
    const newStatus = this.value;
    try {
      const data = await ajaxPost(url, { user_id: uid, status: newStatus });
      if (data.ok) {
        const icons = { pending: 'bi-hourglass-split', verified: 'bi-patch-check-fill', rejected: 'bi-x-circle-fill' };
        const badge = document.getElementById('badge-' + uid);
        badge.className = 'badge badge-' + data.status;
        badge.innerHTML = '<i class="bi ' + icons[data.status] + '"></i> ' + data.status.charAt(0).toUpperCase() + data.status.slice(1);
        toast('<strong>' + data.username + '</strong> → ' + data.status, 'success');
      } else {
        toast(data.error || 'Failed to update.', 'error');
      }
    } catch (e) {
      toast('Network error. Try again.', 'error');
    }
  });
});

// Delete user
let deleteId = null, deleteUrl = null;
document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    deleteId  = this.dataset.userId;
    deleteUrl = this.dataset.url;
    document.getElementById('deleteModalUsername').textContent = this.dataset.username;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
  });
});

document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
  if (!deleteId) return;
  try {
    const data = await ajaxPost(deleteUrl, { user_id: deleteId });
    if (data.ok) {
      const row = document.getElementById('user-row-' + deleteId);
      if (row) { row.style.opacity = '0'; row.style.transition = 'opacity .3s'; setTimeout(() => row.remove(), 300); }
      bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
      toast('User <strong>' + data.username + '</strong> deleted.', 'success');
    } else {
      toast(data.error || 'Delete failed.', 'error');
    }
  } catch (e) {
    toast('Network error. Try again.', 'error');
  }
  deleteId = null;
});
</script>
{% endblock %}
